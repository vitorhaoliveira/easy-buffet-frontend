<div class="space-y-6">
  <!-- Header -->
  <div class="flex items-center space-x-4">
    <button appButton variant="ghost" size="sm" (click)="handleCancel()">
      <lucide-icon [img]="ArrowLeftIcon" class="h-4 w-4 mr-2"></lucide-icon>
      Voltar
    </button>
    <div>
      <h1 class="text-3xl font-bold tracking-tight">
        {{ isEditing ? 'Editar Contrato' : 'Novo Contrato' }}
      </h1>
      <p class="text-muted-foreground">
        @if (quoteIdFromConversion) {
          Contrato a partir do orçamento aceito. Valor e dados do evento/cliente já preenchidos. Informe as condições de pagamento.
        } @else {
          {{ isEditing ? 'Atualize as informações do contrato' : 'Preencha os dados do novo contrato' }}
        }
      </p>
    </div>
  </div>

  <!-- Error Message -->
  @if (errorMessage) {
  <div class="w-full p-3 text-sm text-red-600 bg-red-50 border border-red-200 rounded-md">
    {{ errorMessage }}
  </div>
  }

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Formulário -->
    @if (!isLoadingData) {
    <form [formGroup]="contractForm" (ngSubmit)="handleSubmit()" class="space-y-6">
      <div class="bg-white rounded-xl shadow-sm border p-4 sm:p-6 space-y-4">
        <h3 class="text-lg font-semibold flex items-center space-x-2">
          <lucide-icon [img]="FileTextIcon" class="h-5 w-5"></lucide-icon>
          <span>Dados do Contrato</span>
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Evento (pesquisa + paginação com Carregar mais) -->
          <div class="space-y-2 relative">
            <label appLabel>Evento *</label>
            <div class="relative">
              <button type="button" [disabled]="isLoadingData" (click)="eventDropdownOpen = !eventDropdownOpen; clientDropdownOpen = false"
                [class]="'flex min-h-[44px] w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm text-left ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:cursor-not-allowed disabled:opacity-50 ' + (hasError('eventId') ? 'border-red-500' : '')">
                <span [class]="getSelectedEventName() ? 'text-foreground' : 'text-muted-foreground'">{{ getSelectedEventName() || (isLoadingData ? 'Carregando eventos...' : 'Selecione um evento') }}</span>
                <svg class="h-4 w-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
              </button>
              @if (eventDropdownOpen) {
              <div class="absolute z-50 mt-1 w-full rounded-md border border-input bg-background shadow-lg max-h-64 flex flex-col">
                <input type="text" [(ngModel)]="eventSearchTerm" [ngModelOptions]="{standalone: true}" placeholder="Pesquisar evento..."
                  class="m-2 rounded border border-input px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500" (click)="$event.stopPropagation()" />
                <div class="overflow-y-auto flex-1 min-h-0">
                  @for (event of filteredEvents; track event.id) {
                  <button type="button" (click)="selectEvent(event)" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 transition-colors" [class.bg-primary-50]="contractForm.get('eventId')?.value === event.id">
                    {{ event.name }}
                  </button>
                  }
                  @if (filteredEvents.length === 0) {
                  <p class="px-3 py-2 text-sm text-muted-foreground">Nenhum evento encontrado</p>
                  }
                </div>
                @if (eventsPagination && eventsPage < eventsPagination.totalPages) {
                <button type="button" (click)="loadMoreEvents()" [disabled]="isLoadingMoreEvents" class="border-t border-input px-3 py-2 text-sm font-medium text-primary-600 hover:bg-primary-50 disabled:opacity-50">
                  {{ isLoadingMoreEvents ? 'Carregando...' : 'Carregar mais eventos' }}
                </button>
                }
              </div>
              <div class="fixed inset-0 z-40" (click)="closeEventDropdown()"></div>
              }
            </div>
            @if (hasError('eventId')) {
            <p class="text-sm text-red-500">{{ getFieldError('eventId') }}</p>
            }
          </div>

          <!-- Cliente (pesquisa + paginação com Carregar mais) -->
          <div class="space-y-2 relative">
            <label appLabel>Cliente *</label>
            <div class="relative">
              <button type="button" [disabled]="isLoadingData" (click)="clientDropdownOpen = !clientDropdownOpen; eventDropdownOpen = false"
                [class]="'flex min-h-[44px] w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm text-left ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:cursor-not-allowed disabled:opacity-50 ' + (hasError('clientId') ? 'border-red-500' : '')">
                <span [class]="getSelectedClientName() ? 'text-foreground' : 'text-muted-foreground'">{{ getSelectedClientName() || (isLoadingData ? 'Carregando clientes...' : 'Selecione um cliente') }}</span>
                <svg class="h-4 w-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
              </button>
              @if (clientDropdownOpen) {
              <div class="absolute z-50 mt-1 w-full rounded-md border border-input bg-background shadow-lg max-h-64 flex flex-col">
                <input type="text" [(ngModel)]="clientSearchTerm" [ngModelOptions]="{standalone: true}" placeholder="Pesquisar cliente..."
                  class="m-2 rounded border border-input px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500" (click)="$event.stopPropagation()" />
                <div class="overflow-y-auto flex-1 min-h-0">
                  @for (client of filteredClients; track client.id) {
                  <button type="button" (click)="selectClient(client)" class="w-full text-left px-3 py-2 text-sm hover:bg-primary-50 transition-colors" [class.bg-primary-50]="contractForm.get('clientId')?.value === client.id">
                    {{ client.name }}
                  </button>
                  }
                  @if (filteredClients.length === 0) {
                  <p class="px-3 py-2 text-sm text-muted-foreground">Nenhum cliente encontrado</p>
                  }
                </div>
                @if (clientsPagination && clientsPage < clientsPagination.totalPages) {
                <button type="button" (click)="loadMoreClients()" [disabled]="isLoadingMoreClients" class="border-t border-input px-3 py-2 text-sm font-medium text-primary-600 hover:bg-primary-50 disabled:opacity-50">
                  {{ isLoadingMoreClients ? 'Carregando...' : 'Carregar mais clientes' }}
                </button>
                }
              </div>
              <div class="fixed inset-0 z-40" (click)="closeClientDropdown()"></div>
              }
            </div>
            @if (hasError('clientId')) {
            <p class="text-sm text-red-500">{{ getFieldError('clientId') }}</p>
            }
          </div>

          <!-- Vendedor -->
          <div class="space-y-2">
            <label appLabel htmlFor="sellerId">Vendedor(a)</label>
            <select id="sellerId" formControlName="sellerId" [disabled]="isLoadingData"
              class="flex min-h-[44px] w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:cursor-not-allowed disabled:opacity-50">
              <option value="">{{ isLoadingData ? 'Carregando vendedores...' : 'Selecione um vendedor (opcional)' }}
              </option>
              @for (seller of sellers; track seller.id) {
              <option [value]="seller.id">{{ seller.name }}</option>
              }
            </select>
          </div>

          <!-- Valor Total -->
          <div class="space-y-2">
            <label appLabel htmlFor="totalAmount">Valor Total *</label>
            <input type="number" step="0.01" min="0" id="totalAmount" formControlName="totalAmount" placeholder="0.00"
              [class]="'flex min-h-[44px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:cursor-not-allowed disabled:opacity-50 ' + (hasError('totalAmount') ? 'border-red-500' : '')" />
            @if (hasError('totalAmount')) {
            <p class="text-sm text-red-500">{{ getFieldError('totalAmount') }}</p>
            }
          </div>

          <!-- Valor de Entrada (opcional) -->
          <div class="space-y-2">
            <label appLabel htmlFor="entrada">Valor de entrada (opcional)</label>
            <input type="number" step="0.01" min="0" id="entrada" formControlName="entrada" placeholder="0.00"
              [class]="'flex min-h-[44px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:cursor-not-allowed disabled:opacity-50 ' + (hasError('entrada') ? 'border-red-500' : '')" />
            <p class="text-xs text-muted-foreground">Deixe em branco ou 0 para não informar entrada. Deve ser menor que o valor total.</p>
            @if (hasError('entrada')) {
            <p class="text-sm text-red-500">{{ getFieldError('entrada') }}</p>
            }
          </div>

          <!-- Número de Parcelas -->
          <div class="space-y-2">
            <label appLabel htmlFor="installmentCount">Número de Parcelas *</label>
            <input type="number" min="1" id="installmentCount" formControlName="installmentCount" placeholder="1"
              [attr.min]="isEditing && paidInstallmentsCount > 0 ? paidInstallmentsCount : 1"
              [class]="'flex min-h-[44px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:cursor-not-allowed disabled:opacity-50 ' + (hasError('installmentCount') ? 'border-red-500' : '')" />
            @if (isEditing && paidInstallmentsCount > 0) {
            <p class="text-xs text-muted-foreground">Mínimo: {{ paidInstallmentsCount }} parcela(s) (já pagas)</p>
            }
            @if (hasError('installmentCount')) {
            <p class="text-sm text-red-500">{{ getFieldError('installmentCount') }}</p>
            }
          </div>

          <!-- Data da Primeira Parcela -->
          <div class="space-y-2">
            <label appLabel htmlFor="firstDueDate">Data da Primeira Parcela *</label>
            <input type="date" id="firstDueDate" formControlName="firstDueDate"
              [class]="'flex min-h-[44px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:cursor-not-allowed disabled:opacity-50 ' + (hasError('firstDueDate') ? 'border-red-500' : '')" />
            @if (hasError('firstDueDate')) {
            <p class="text-sm text-red-500">{{ getFieldError('firstDueDate') }}</p>
            }
          </div>

          <!-- Periodicidade -->
          <div class="space-y-2">
            <label appLabel htmlFor="periodicity">Periodicidade *</label>
            <select id="periodicity" formControlName="periodicity"
              class="flex min-h-[44px] w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:cursor-not-allowed disabled:opacity-50">
              <option value="Semanal">Semanal</option>
              <option value="Quinzenal">Quinzenal</option>
              <option value="Mensal">Mensal</option>
              <option value="Bimestral">Bimestral</option>
              <option value="Trimestral">Trimestral</option>
              <option value="Semestral">Semestral</option>
              <option value="Anual">Anual</option>
            </select>
          </div>

          <!-- Observações -->
          <div class="space-y-2 md:col-span-2">
            <label appLabel htmlFor="notes">Observações</label>
            <textarea id="notes" formControlName="notes" placeholder="Observações adicionais sobre o contrato..."
              class="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:cursor-not-allowed disabled:opacity-50"
              rows="3"></textarea>
          </div>

          <!-- Status -->
          <div class="space-y-2">
            <label appLabel htmlFor="status">Status *</label>
            <select id="status" formControlName="status"
              class="flex min-h-[44px] w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:cursor-not-allowed disabled:opacity-50">
              <option value="Pendente">Pendente</option>
              <option value="Assinado">Assinado</option>
              <option value="Cancelado">Cancelado</option>
            </select>
          </div>

          <!-- Data de Assinatura (condicional) -->
          @if (showSignedAtField) {
          <div class="space-y-2">
            <label appLabel htmlFor="signedAt">Data de Assinatura *</label>
            <input type="date" id="signedAt" formControlName="signedAt"
              [class]="'flex min-h-[44px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:cursor-not-allowed disabled:opacity-50 ' + (hasError('signedAt') ? 'border-red-500' : '')" />
            @if (hasError('signedAt')) {
            <p class="text-sm text-red-500">{{ getFieldError('signedAt') }}</p>
            }
          </div>
          }
        </div>
      </div>

      <!-- Botões -->
      <div class="flex items-center justify-end space-x-2 pt-6 border-t">
        <button appButton type="button" variant="outline" (click)="handleCancel()" [disabled]="isLoading">
          <lucide-icon [img]="XIcon" class="h-4 w-4 mr-2"></lucide-icon>
          Cancelar
        </button>
        <button appButton type="submit" variant="outline" [disabled]="isLoading">
          <lucide-icon [img]="SaveIcon" class="h-4 w-4 mr-2"></lucide-icon>
          {{ isLoading ? 'Salvando...' : (isEditing ? 'Atualizar' : 'Salvar') }}
        </button>
      </div>
    </form>
    }

    <!-- Resumo do Contrato -->
    <div class="space-y-4">
      <h3 class="text-lg font-semibold flex items-center space-x-2">
        <lucide-icon [img]="FileTextIcon" class="h-5 w-5"></lucide-icon>
        <span>Resumo do Contrato</span>
      </h3>

      <div class="bg-blue-50 p-4 rounded-lg space-y-3">
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div>
            <span class="font-medium text-blue-900">Valor por Parcela:</span>
            <p class="text-lg font-bold text-blue-700">
              {{ installmentAmount > 0 ? formatCurrency(installmentAmount) : 'R$ 0,00' }}
            </p>
            @if (showEntradaInSummary) {
            <p class="text-xs text-blue-700 mt-1">(valor total menos entrada, dividido em parcelas)</p>
            }
          </div>
        </div>

        <div class="pt-2 border-t border-blue-200">
          <p class="text-sm text-blue-800 mb-2">
            <strong>Valor Total:</strong> {{ contractForm.get('totalAmount')?.value ?
            formatCurrency(contractForm.get('totalAmount')?.value) : 'R$ 0,00' }}
          </p>
          @if (showEntradaInSummary) {
          <p class="text-sm text-blue-800 mb-2">
            <strong>Entrada:</strong> {{ formatCurrency(entradaSummaryValue) }}
          </p>
          }
          <p class="text-sm text-blue-800">
            <strong>Parcelas:</strong> {{ contractForm.get('installmentCount')?.value || '0' }} x {{
            contractForm.get('periodicity')?.value }}
          </p>
        </div>
      </div>

      <div class="bg-green-50 p-4 rounded-lg">
        <p class="text-sm text-green-800 mb-2">
          <strong>✨ Criação Automática de Parcelas</strong>
        </p>
        <p class="text-sm text-green-700">
          O sistema criará automaticamente todas as parcelas baseadas na periodicidade escolhida.
          Você poderá gerenciar as parcelas na seção Financeiro após a criação do contrato.
        </p>
      </div>
    </div>
  </div>
</div>