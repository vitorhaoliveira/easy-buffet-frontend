<div class="w-full">
  <!-- Header -->
  <div class="flex items-center gap-4 mb-6">
    <button 
      (click)="handleCancel()"
      class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
    >
      <lucide-icon [img]="ArrowLeftIcon" class="w-5 h-5 text-gray-600"></lucide-icon>
    </button>
    <div>
      <h1 class="text-2xl font-bold text-gray-900">
        {{ isEditing ? 'Editar Template' : 'Novo Template de Checklist' }}
      </h1>
      <p class="text-gray-600 mt-1">
        {{ isEditing ? 'Atualize as informações do template' : 'Crie um novo template reutilizável' }}
      </p>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoadingData" class="flex justify-center py-12">
    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
  </div>

  <!-- Error -->
  <div *ngIf="errorMessage" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
    {{ errorMessage }}
  </div>

  <!-- Form -->
  <form *ngIf="!isLoadingData" [formGroup]="templateForm" (ngSubmit)="handleSubmit()" class="space-y-6">
    <!-- Basic Info Card -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Informações Básicas</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Name -->
        <div>
          <app-label for="name" required>Nome do Template</app-label>
          <input
            type="text"
            id="name"
            formControlName="name"
            placeholder="Ex: Checklist Casamento Completo"
            class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            [ngClass]="{'border-red-500': hasError('name'), 'border-gray-300': !hasError('name')}"
          />
          <p *ngIf="hasError('name')" class="mt-1 text-sm text-red-600">{{ getFieldError('name') }}</p>
        </div>

        <!-- Event Type -->
        <div>
          <app-label for="eventType" required>Tipo de Evento</app-label>
          <select
            id="eventType"
            formControlName="eventType"
            class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            [ngClass]="{'border-red-500': hasError('eventType'), 'border-gray-300': !hasError('eventType')}"
          >
            <option value="">Selecione o tipo</option>
            <option *ngFor="let type of eventTypes" [value]="type">{{ type }}</option>
          </select>
          <p *ngIf="hasError('eventType')" class="mt-1 text-sm text-red-600">{{ getFieldError('eventType') }}</p>
        </div>

        <!-- Description -->
        <div class="md:col-span-2">
          <app-label for="description">Descrição</app-label>
          <textarea
            id="description"
            formControlName="description"
            rows="3"
            placeholder="Descreva o objetivo deste template..."
            class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          ></textarea>
        </div>

        <!-- Is Active -->
        <div class="flex items-center gap-2">
          <input
            type="checkbox"
            id="isActive"
            formControlName="isActive"
            class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
          />
          <label for="isActive" class="text-sm text-gray-700">Template ativo</label>
        </div>
      </div>
    </div>

    <!-- Items Card -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900">Itens do Checklist</h2>
        <button
          type="button"
          (click)="addItem()"
          class="flex items-center gap-1 px-3 py-1.5 text-sm text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
        >
          <lucide-icon [img]="PlusIcon" class="w-4 h-4"></lucide-icon>
          Adicionar Item
        </button>
      </div>

      <!-- Empty State -->
      <div *ngIf="items.length === 0" class="text-center py-8 text-gray-500">
        <p>Nenhum item adicionado</p>
        <button
          type="button"
          (click)="addItem()"
          class="mt-2 text-indigo-600 hover:text-indigo-700"
        >
          Adicionar primeiro item
        </button>
      </div>

      <!-- Items List -->
      <div formArrayName="items" class="space-y-4">
        <div 
          *ngFor="let item of items.controls; let i = index"
          [formGroupName]="i"
          class="border border-gray-200 rounded-lg p-4 bg-gray-50"
        >
          <!-- Item Header -->
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <lucide-icon [img]="GripVerticalIcon" class="w-4 h-4 text-gray-400 cursor-move"></lucide-icon>
              <span class="text-sm font-medium text-gray-700">Item {{ i + 1 }}</span>
              <span 
                class="text-xs px-2 py-0.5 rounded border"
                [ngClass]="getPhaseColor(item.get('phase')?.value)"
              >
                {{ getPhaseLabel(item.get('phase')?.value) }}
              </span>
            </div>
            <div class="flex items-center gap-1">
              <button
                type="button"
                (click)="moveItem(i, 'up')"
                [disabled]="i === 0"
                class="p-1 text-gray-400 hover:text-gray-600 disabled:opacity-30"
                title="Mover para cima"
              >
                ↑
              </button>
              <button
                type="button"
                (click)="moveItem(i, 'down')"
                [disabled]="i === items.length - 1"
                class="p-1 text-gray-400 hover:text-gray-600 disabled:opacity-30"
                title="Mover para baixo"
              >
                ↓
              </button>
              <button
                type="button"
                (click)="removeItem(i)"
                class="p-1 text-red-400 hover:text-red-600"
                title="Remover item"
              >
                <lucide-icon [img]="Trash2Icon" class="w-4 h-4"></lucide-icon>
              </button>
            </div>
          </div>

          <!-- Item Fields -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <!-- Title -->
            <div class="md:col-span-2">
              <input
                type="text"
                formControlName="title"
                placeholder="Título do item *"
                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                [ngClass]="{'border-red-500': hasItemError(i, 'title'), 'border-gray-300': !hasItemError(i, 'title')}"
              />
            </div>

            <!-- Description -->
            <div class="md:col-span-2">
              <input
                type="text"
                formControlName="description"
                placeholder="Descrição (opcional)"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
              />
            </div>

            <!-- Phase -->
            <div>
              <label class="block text-xs text-gray-600 mb-1">Fase</label>
              <select
                formControlName="phase"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
              >
                <option *ngFor="let phase of phases" [value]="phase.value">
                  {{ phase.label }}
                </option>
              </select>
            </div>

            <!-- Priority -->
            <div>
              <label class="block text-xs text-gray-600 mb-1">Prioridade</label>
              <select
                formControlName="priority"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
              >
                <option *ngFor="let priority of priorities" [value]="priority.value">
                  {{ priority.label }}
                </option>
              </select>
            </div>

            <!-- Days Before Event -->
            <div>
              <label class="block text-xs text-gray-600 mb-1">Dias antes do evento</label>
              <input
                type="number"
                formControlName="daysBeforeEvent"
                placeholder="Ex: 7"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
              />
              <p class="text-xs text-gray-500 mt-1">Negativo = após evento</p>
            </div>

            <!-- Responsible Role -->
            <div>
              <label class="block text-xs text-gray-600 mb-1">Setor Responsável</label>
              <select
                formControlName="responsibleRole"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
              >
                <option value="">Nenhum</option>
                <option *ngFor="let role of responsibleRoles" [value]="role">
                  {{ role }}
                </option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Item Button (bottom) -->
      <div *ngIf="items.length > 0" class="mt-4 pt-4 border-t border-gray-200">
        <button
          type="button"
          (click)="addItem()"
          class="flex items-center gap-1 text-sm text-indigo-600 hover:text-indigo-700"
        >
          <lucide-icon [img]="PlusIcon" class="w-4 h-4"></lucide-icon>
          Adicionar mais um item
        </button>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex items-center justify-end gap-3">
      <button 
        type="button" 
        appButton 
        variant="outline" 
        (click)="handleCancel()"
      >
        Cancelar
      </button>
      <button 
        type="submit" 
        appButton 
        variant="default" 
        [disabled]="isLoading"
      >
        <lucide-icon *ngIf="!isLoading" [img]="SaveIcon" class="w-4 h-4 mr-2"></lucide-icon>
        <span *ngIf="isLoading" class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></span>
        {{ isEditing ? 'Salvar Alterações' : 'Criar Template' }}
      </button>
    </div>
  </form>
</div>

